\chapter{Transfers}

The TCU uses \emph{transfers} to load data from local memory or write data into local memory. Since
these local memory accesses need to be performed in multiple steps and need to be paused and
resumed\colorbox{pemux}{, under some conditions,} the TCU maintains state for each transfer and
supports a limited number of transfers at a time (at least 2). However, the transfers and their
states are not software facing, so that this specification does not describe any software interface,
but only the behavior of transfers.

There are two different kinds of transfers: \emph{local transfers} issued by \texttt{read\_local()},
\texttt{write\_local()}, or \texttt{write\_local\_phys()} and \emph{remote transfers} issued by
\texttt{read\_remote()} or \texttt{write\_remote()} (see \rref{sec:unprivcmdspseudo}). Local
transfers always belong to the current unprivileged command, implying that there is at most one.
Remote transfers are triggered by requests from other TCUs (e.g., an incoming message or an access
to the local memory).

\cbstart
\section{Translations}

With virtual memory support, all transfers except \texttt{write\_local\_phys()} refer to a virtual
address and thus require address translations to determine the physical address for the actual
memory access. The TCU keeps a small translation look-aside buffer~(TLB) to cache these translations
and issues a translation core request on TLB misses. In this case, the transfer is paused until the
completion of a translation core request, which creates a corresponding new TLB entry and resumes
the transfer.

While both local and remote transfers require address translations, only local transfers can cause
page faults. If a remote transfer triggers a page fault (due to insufficient permissions, either in
TLB or reported by software upon a translation core request), the transfer is aborted with the error
\texttt{PAGEFAULT}. Local transfers can cause page faults, leading to potentially long transfer
times.

Without virtual memory support, there is no difference between \texttt{write\_local()} and
\texttt{write\_local\_phys()}. However, with virtual memory support, \texttt{write\_local\_phys()}
refers to a physical address, so that no translation is required.

\section{Translation Look-aside Buffer}
\label{sec:tlb}

The TLB contains a virtual address, 16-bit address space id~(asid), physical address, and
permissions. The permissions are defined as follows:

\begin{itemize}
  \item \texttt{READ} (1): read permission,
  \item \texttt{WRITE} (2): write permission,
  \item \texttt{EXEC} (4): execute permission \todo{remove that?},
  \item \texttt{LARGE} (8): large page mapping (2 MiB),
  \item \texttt{FIXED} (16): fixed entry, will not be evicted.
\end{itemize}
\cbend
