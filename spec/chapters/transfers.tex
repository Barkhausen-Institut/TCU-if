\chapter{Transfers}

The TCU uses \emph{transfers} to load data from local memory or write data into local memory. Since
these local memory accesses need to be performed in multiple steps and need to be paused and
resumed\colorbox{vm}{, under some conditions,} the TCU maintains state for each transfer and
supports a limited number of transfers at a time (at least 2). However, the transfers and their
states are not software facing, so that this specification does not describe any software interface,
but only the behavior of transfers.

There are two different kinds of transfers: \emph{local transfers} issued by \texttt{read\_local()},
\texttt{write\_local()}, or \texttt{write\_local\_phys()} and \emph{remote transfers} issued by
\texttt{read\_remote\_phys()} or \texttt{write\_remote\_phys()} (see \rref{sec:unprivcmdspseudo}).
Local transfers always belong to the current unprivileged command, implying that there is at most
one. Remote transfers are triggered by requests from other TCUs (e.g., an incoming message or a
remote access to the local memory), implying that there may be multiple remote transfers at a time.

\extstart{vm}
\section{Translations}
\label{sec:xlates}

With virtual memory support, all local transfers except \texttt{write\_local\_phys()} refer to a
virtual address and thus require address translations to determine the physical address for the
actual memory access. Remote transfers always refer to physical memory, requiring no translation.
The TCU keeps a small translation look-aside buffer~(TLB) to cache these translations and issues a
translation core request on TLB misses via \texttt{queue\_xlate\_req()}. In this case, the transfer
is paused until the completion of a translation core request, which creates a corresponding new TLB
entry and resumes the transfer. These translations can also lead to page faults, leading to
potentially long transfer times. The privileged software can report that the translation failed
(e.g., the virtual address is not mapped) by setting all permission bits to 0, in which case the
transfer is aborted with the error \texttt{PAGEFAULT}.

Without virtual memory support, \texttt{write\_local()} and \texttt{write\_local\_phys()} are
equivalent. However, with virtual memory support, \texttt{write\_local\_phys()} refers to a physical
address, so that no translation is required, in contrast to \texttt{write\_local()}.

\section{Translation Look-aside Buffer}
\label{sec:tlb}

The TLB contains a 32-bit virtual address, 16-bit address space id~(asid), 64-bit physical address,
and 5 bits for permissions. Small pages are 4~KiB and large pages 2~MiB. The virtual and physical
address are always page-size aligned. The permissions are defined as follows:

\begin{itemize}
  \item \texttt{READ} (1): read permission,
  \item \texttt{WRITE} (2): write permission,
  \item \texttt{EXEC} (4): execute permission \todo{remove that?},
  \item \texttt{LARGE} (8): large page mapping,
  \item \texttt{FIXED} (16): fixed entry, will not be evicted.
\end{itemize}
\extend{}
